<!DOCTYPE html>
<html lang="tr">
  <head>
    <meta charset="UTF-8" />
    <title>Anasayfa - PixelCarProject</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div class="container">
      <div class="user-info-wrapper">
        <div class="panel-navbar">
          <span class="panel-navbar-title">PixelCarProject</span>
        </div>
        <div class="user-info" id="user-info">
          <!-- Giriş yapmamış kullanıcı için giriş formu -->
          <div class="login-card" id="login-card">
            <h2>Giriş Yap</h2>
            <form id="login-form">
              <input
                type="text"
                id="login-username"
                placeholder="Kullanıcı Adı"
                required
              />
              <input
                type="password"
                id="login-password"
                placeholder="Şifre"
                style="display:none"
              />
              <button type="submit">Giriş Yap</button>
              <div
                id="login-error"
                style="color: red; margin-top: 8px; display: none"
              ></div>
            </form>
          </div>
          <!-- Ayrıntılı kayıt formu (başta gizli) -->
          <div
            class="register-card login-card"
            id="register-card"
            style="display: none"
          >
            <h2>Kayıt Ol</h2>
            <form id="register-form">
              <input
                type="text"
                id="register-username"
                placeholder="Kullanıcı Adı"
                maxlength="20"
                required
              />
              <input
                type="email"
                id="register-email"
                placeholder="E-posta"
                required
              />
              <input
                type="password"
                id="register-password"
                placeholder="Şifre"
                required
              />
              <input
                type="password"
                id="register-password2"
                placeholder="Şifre Tekrar"
                required
              />
              <input
                type="text"
                id="register-tag"
                placeholder="Kart Etiketi (max 2 karakter)"
                maxlength="2"
                required
              />
              <div
                style="
                  margin: 8px 0 0 0;
                  display: flex;
                  flex-direction: column;
                  gap: 2px;
                "
              >
                <label class="custom-checkbox-label">
                  <input
                    type="checkbox"
                    id="register-eula-checkbox"
                    class="custom-checkbox"
                  />
                  <span class="custom-checkbox-box"></span>
                  <span class="custom-checkbox-text">
                    <a
                      href="#"
                      id="register-eula-link"
                      style="
                        color: #ffd700;
                        text-decoration: underline;
                        cursor: pointer;
                        font-size: 0.91em;
                      "
                      >EULA</a
                    >'yı kabul ediyorum
                  </span>
                </label>
                <label class="custom-checkbox-label">
                  <input
                    type="checkbox"
                    id="register-tos-checkbox"
                    class="custom-checkbox"
                  />
                  <span class="custom-checkbox-box"></span>
                  <span class="custom-checkbox-text">
                    <a
                      href="#"
                      id="register-tos-link"
                      style="
                        color: #ffd700;
                        text-decoration: underline;
                        cursor: pointer;
                        font-size: 0.91em;
                      "
                      >Hizmet Şartları</a
                    >'nı kabul ediyorum
                  </span>
                </label>
              </div>
              <button type="submit" id="register-submit-btn">Kayıt Ol</button>
              <button
                type="button"
                id="back-to-login-btn"
                style="
                  margin-top: 8px;
                  background: #232323;
                  color: #ffd700;
                  border: none;
                  border-radius: 6px;
                  padding: 8px 0;
                  font-size: 1em;
                  cursor: pointer;
                "
              >
                Geri Dön
              </button>
              <div
                id="register-error"
                style="color: red; margin-top: 8px; display: none"
              ></div>
            </form>
            <style>
              .custom-checkbox-label {
                font-size: 0.91em;
                display: flex;
                align-items: center;
                gap: 7px;
                color: #ccc;
                user-select: none;
                cursor: pointer;
              }
              .custom-checkbox {
                display: none;
              }
              .custom-checkbox-box {
                width: 16px;
                height: 16px;
                border: 1.5px solid #ffd700;
                border-radius: 4px;
                background: #232323;
                display: inline-block;
                position: relative;
                transition: box-shadow 0.18s, border-color 0.18s;
                margin: 0;
                vertical-align: middle;
              }
              .custom-checkbox-label:hover .custom-checkbox-box {
                box-shadow: 0 0 0 2px #ffd70099;
                border-color: #ffe066;
              }
              .custom-checkbox:checked + .custom-checkbox-box {
                background: #ffd700;
                border-color: #ffd700;
              }
              .custom-checkbox:checked + .custom-checkbox-box::after {
                content: "";
                position: absolute;
                left: 4px;
                top: 1.5px;
                width: 6px;
                height: 10px;
                border: solid #232323;
                border-width: 0 2.2px 2.2px 0;
                border-radius: 1px;
                transform: rotate(45deg);
                display: block;
              }
              .custom-checkbox-text {
                line-height: 1.2;
                font-size: 0.91em;
              }
            </style>
          </div>
          <!-- Giriş yapmış kullanıcı için gösterilecek alanlar (varsayılan olarak gizli) -->
          <div class="user-content" id="user-content" style="display: none">
            <nav class="side-menu" id="side-menu">
              <a href="#">Galeri</a>
              <a href="#">Sanayi</a>
              <a href="#">Market</a>
              <a href="#">Pazar</a>
              <a href="#" id="user-menu-link">Kullanıcı</a>
            </nav>
            <div
              class="user-card"
              id="user-card"
              style="
                padding: 32px 0 24px 0;
                min-width: 220px;
                max-width: 320px;
                margin: 0 auto 12px auto;
                border-radius: 16px;
                background: #232323;
                box-shadow: 0 4px 24px #0003;
                display: flex;
                flex-direction: column;
                align-items: center;
              "
            >
              <img
                id="user-avatar"
                src="https://ui-avatars.com/api/?name=&background=222&color=fff&size=128"
                alt="Avatar"
                class="user-avatar"
                style="
                  width: 96px;
                  height: 96px;
                  border-radius: 50%;
                  margin-bottom: 12px;
                "
              />
              <div
                class="user-card-name"
                id="user-card-name"
                style="font-size: 1.35em; font-weight: bold"
              >
                Talha
              </div>
              <div
                class="user-card-username"
                id="user-card-username"
                style="font-size: 1.08em; color: #bbb; margin-top: 4px"
              >
                @talha
              </div>
            </div>
          </div>
          <div
            style="
              position: absolute;
              left: 0;
              right: 0;
              bottom: 18px;
              text-align: center;
              color: #888;
              font-size: 0.97em;
              pointer-events: none;
            "
          >
            © 2024 PixelCarProject. Tüm hakları saklıdır.<a
              id="eula-link"
              href="#"
              style="
                color: #ffd700;
                text-decoration: none;
                margin-left: 8px;
                font-size: 0.97em;
                opacity: 0.85;
                pointer-events: auto;
                cursor: pointer;
              "
              >EULA</a
            >
          </div>
        </div>
      </div>
      <div class="chat-channel-wrapper">
        <div class="panel-navbar">
          <span class="panel-navbar-title">Sohbet</span>
        </div>
        <div
          class="chat-channel"
          style="
            position: relative;
            display: flex;
            flex-direction: column;
            height: 420px;
            max-height: 100%;
          "
        >
          <div class="chat-header" id="chat-header" style="position: relative">
            Sohbet Kanalı
            <span
              id="chat-status-indicator"
              style="
                position: absolute;
                left: 50%;
                top: 50%;
                transform: translate(-50%, -50%);
                font-size: 1em;
                font-weight: bold;
              "
            ></span>
          </div>

          <div
            class="chat-messages"
            id="chat-messages"
            style="
              flex: 1 1 0;
              min-height: 0;
              max-height: 100%;
              overflow-y: auto;
            "
          >
            <!-- Sohbet mesajları burada listelenecek -->
          </div>
          <form
            class="chat-input-area"
            id="chat-form"
            autocomplete="off"
            style="
              background: #222;
              border-top: 1.5px solid #444;
              display: flex;
              flex-direction: column;
            "
          >
            <div
              id="typing-indicator"
              style="
                min-height: 22px;
                color: #ffd700;
                font-size: 0.99em;
                padding: 2px 8px 2px 0;
                background: transparent;
                opacity: 1;
                transition: opacity 0.22s;
                position: relative;
                display: flex;
                flex-direction: row;
                align-items: center;
                justify-content: space-between;
                width: 100%;
                text-align: left;
                z-index: 2;
              "
            >
              <span id="typing-users-span" style="flex:1; text-align:left; color:#ffd700; font-size:0.99em; min-width:0; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; opacity:1;"></span>
              <span id="online-count" style="flex:1; text-align:center; color:#43a047; font-weight:bold; font-size:1.01em; opacity:1;"></span>
              <span id="char-counter-span" style="flex:1; text-align:right; color:#ffd700; font-size:0.99em; opacity:1;"></span>
            </div>
            <div style="display: flex; align-items: center">
              <input
                type="text"
                id="chat-input"
                placeholder="Mesajınızı yazın..."
                style="
                  background: #222;
                  color: #fff;
                  border: 1.5px solid #444;
                  border-radius: 6px;
                  padding: 10px 14px;
                  font-size: 1em;
                  outline: none;
                  transition: border 0.2s;
                  flex: 1;
                "
              />
              <button
                id="send-btn"
                type="submit"
                style="
                  padding: 10px 24px;
                  border-radius: 6px;
                  border: none;
                  background: #ffd700;
                  color: #222;
                  font-weight: bold;
                  font-size: 1.08em;
                  cursor: pointer;
                  margin-left: 8px;
                  transition: background 0.18s, color 0.18s;
                "
              >
                Gönder
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
    <!-- Çıkış menüsü (sayfanın en sonunda, user-card dışında) -->
    <div
      id="logout-menu"
      style="
        display: none;
        position: fixed;
        background: #232323;
        border-radius: 8px;
        box-shadow: 0 4px 16px #0006;
        padding: 0;
        z-index: 1000;
      "
    >
      <div class="logout-option" id="profile-edit-btn" tabindex="0">
        Profili Düzenle
      </div>
      <div class="logout-option" id="change-password-btn" tabindex="0">
        Şifreyi Değiştir
      </div>
      <div class="logout-option" id="logout-btn" tabindex="0">Çıkış Yap</div>
    </div>

    <!-- Profil düzenleme modalı -->
    <div
      id="profile-edit-modal"
      style="
        display: none;
        position: fixed;
        left: 0;
        top: 0;
        width: 100vw;
        height: 100vh;
        background: #000a;
        z-index: 2000;
        align-items: center;
        justify-content: center;
      "
    >
      <div
        style="
          background: #232323;
          border-radius: 12px;
          padding: 32px 28px;
          min-width: 320px;
          color: #fff;
          box-shadow: 0 4px 32px #000a;
          display: flex;
          flex-direction: column;
          gap: 9px;
          align-items: center;
          position: relative;
        "
      >
        <span
          style="
            position: absolute;
            right: 18px;
            top: 12px;
            cursor: pointer;
            font-size: 1.3em;
          "
          id="close-profile-edit"
          >&times;</span
        >
        <h2 style="margin: 0 0 12px 0">Profili Düzenle</h2>
        <label
          for="edit-username"
          style="width: 100%; text-align: left; margin-bottom: 0"
          >Kullanıcı Adı</label
        >
        <input
          id="edit-username"
          type="text"
          maxlength="20"
          style="
            width: 100%;
            padding: 10px;
            border-radius: 6px;
            border: 1.5px solid #444;
            background: #222;
            color: #fff;
            font-size: 1em;
            margin-top: 4px;
          "
          autocomplete="new-password"
          autocorrect="off"
          autocapitalize="off"
          spellcheck="false"
          inputmode="text"
          tabindex="1"
          onfocus="this.setAttribute('autocomplete','new-password');"
          onmousedown="this.setAttribute('autocomplete','new-password');"
        />
        <div
          id="profile-edit-info"
          style="color: #ffd700; font-size: 0.98em; margin-bottom: 8px"
        ></div>
        <label
          for="edit-displayname"
          style="width: 100%; text-align: left; margin-bottom: 0"
          >Görünen Ad</label
        >
        <input
          id="edit-displayname"
          type="text"
          maxlength="20"
          style="
            width: 100%;
            padding: 10px;
            border-radius: 6px;
            border: 1.5px solid #444;
            background: #222;
            color: #fff;
            font-size: 1em;
            margin-top: 4px;
          "
        />
        <div
          id="displayname-edit-info"
          style="color: #ffd700; font-size: 0.98em; margin-bottom: 8px"
        ></div>
        <label
          for="edit-tag"
          style="width: 100%; text-align: left; margin-bottom: 0"
          >Kart Etiketi</label
        >
        <input
          id="edit-tag"
          type="text"
          placeholder="2&"
          maxlength="2"
          style="
            width: 100%;
            padding: 10px;
            border-radius: 6px;
            border: 1.5px solid #444;
            background: #222;
            color: #fff;
            font-size: 1em;
            text-transform: uppercase;
            autocomplete: off;
            margin-top: 4px;
          "
        />
        <div
          id="tag-edit-info"
          style="color: #ffd700; font-size: 0.98em; margin-bottom: 8px"
        ></div>
        <button
          id="save-profile-btn"
          style="
            padding: 10px 0;
            border-radius: 6px;
            border: none;
            background: #ffd700;
            color: #222;
            font-weight: bold;
            font-size: 1.08em;
            cursor: pointer;
            width: 100%;
          "
        >
          Kaydet
        </button>
        <button
          id="delete-account-btn"
          style="
            margin-top: 10px;
            padding: 10px 0;
            border-radius: 6px;
            border: 2px solid #e53935;
            background: transparent;
            color: #e53935;
            font-weight: bold;
            font-size: 1.08em;
            cursor: pointer;
            width: 100%;
          "
        >
          Hesabı Sil
        </button>
      </div>
    </div>

    <!-- Hesabı Sil Onay Modalı -->
    <div
      id="delete-account-confirm-modal"
      style="
        display: none;
        position: fixed;
        left: 0;
        top: 0;
        width: 100vw;
        height: 100vh;
        background: #000a;
        z-index: 3000;
        align-items: center;
        justify-content: center;
      "
    >
      <div
        style="
          background: #232323;
          border-radius: 12px;
          padding: 32px 28px;
          min-width: 320px;
          color: #fff;
          box-shadow: 0 4px 32px #000a;
          display: flex;
          flex-direction: column;
          gap: 18px;
          align-items: center;
          position: relative;
        "
      >
        <span
          style="
            position: absolute;
            right: 18px;
            top: 12px;
            cursor: pointer;
            font-size: 1.3em;
          "
          id="close-delete-account-confirm"
          >&times;</span
        >
        <div style="font-size: 1.13em; text-align: center; margin-bottom: 8px">
          Hesabınızı silmek istediğinizden emin misiniz?
        </div>
        <div
          style="display: flex; gap: 14px; width: 100%; justify-content: center"
        >
          <button
            id="delete-account-confirm-yes"
            style="
              padding: 10px 0;
              border-radius: 6px;
              border: 2px solid #e53935;
              background: transparent;
              color: #e53935;
              font-weight: bold;
              font-size: 1.08em;
              cursor: pointer;
              min-width: 100px;
            "
          >
            Evet
          </button>
          <button
            id="delete-account-confirm-no"
            style="
              padding: 10px 0;
              border-radius: 6px;
              border: none;
              background: #ffd700;
              color: #222;
              font-weight: bold;
              font-size: 1.08em;
              cursor: pointer;
              min-width: 100px;
            "
          >
            Hayır
          </button>
        </div>
      </div>
    </div>

    <!-- Hesabı Sil Doğrulama Modalı -->
    <div
      id="delete-account-verify-modal"
      style="
        display: none;
        position: fixed;
        left: 0;
        top: 0;
        width: 100vw;
        height: 100vh;
        background: #000a;
        z-index: 3100;
        align-items: center;
        justify-content: center;
      "
    >
      <div
        style="
          background: #232323;
          border-radius: 12px;
          padding: 32px 28px;
          min-width: 320px;
          color: #fff;
          box-shadow: 0 4px 32px #000a;
          display: flex;
          flex-direction: column;
          gap: 18px;
          align-items: center;
          position: relative;
        "
      >
        <span
          style="
            position: absolute;
            right: 18px;
            top: 12px;
            cursor: pointer;
            font-size: 1.3em;
          "
          id="close-delete-account-verify"
          >&times;</span
        >
        <div
          id="delete-account-verify-title"
          style="font-size: 1.13em; text-align: center; margin-bottom: 8px"
        ></div>
        <input
          id="delete-account-verify-input"
          type="text"
          placeholder="Kullanıcı adınızı yazınız"
          style="
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
            padding: 10px;
            border-radius: 6px;
            border: 1.5px solid #444;
            background: #222;
            color: #fff;
            font-size: 1em;
          "
        />
        <input
          id="delete-account-verify-password"
          type="password"
          placeholder="Şifrenizi yazınız"
          style="
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
            padding: 10px;
            border-radius: 6px;
            border: 1.5px solid #444;
            background: #222;
            color: #fff;
            font-size: 1em;
          "
        />
        <div
          id="delete-account-verify-error"
          style="
            color: #e53935;
            font-size: 0.98em;
            margin-bottom: 8px;
            display: none;
          "
        ></div>
        <button
          id="delete-account-final-btn"
          style="
            padding: 10px 0;
            border-radius: 6px;
            border: 2px solid #e53935;
            background: transparent;
            color: #e53935;
            font-weight: bold;
            font-size: 1.08em;
            cursor: pointer;
            width: 100%;
          "
        >
          Hesabı Sil
        </button>
      </div>
    </div>

    <!-- Şifre değiştirme modalı -->
    <div
      id="password-modal"
      style="
        display: none;
        position: fixed;
        left: 0;
        top: 0;
        width: 100vw;
        height: 100vh;
        background: #000a;
        z-index: 2000;
        align-items: center;
        justify-content: center;
      "
    >
      <div
        style="
          background: #232323;
          border-radius: 12px;
          padding: 32px 28px;
          min-width: 320px;
          color: #fff;
          box-shadow: 0 4px 32px #000a;
          display: flex;
          flex-direction: column;
          gap: 14px;
          align-items: center;
          position: relative;
        "
      >
        <span
          style="
            position: absolute;
            right: 18px;
            top: 12px;
            cursor: pointer;
            font-size: 1.3em;
          "
          id="close-password-modal"
          >&times;</span
        >
        <h2 style="margin: 0 0 12px 0">Şifreyi Değiştir</h2>
        <input
          id="current-password"
          type="password"
          placeholder="Mevcut Şifre"
          style="
            width: 100%;
            padding: 10px;
            border-radius: 6px;
            border: 1.5px solid #444;
            background: #222;
            color: #fff;
          "
        />
        <input
          id="new-password"
          type="password"
          placeholder="Yeni Şifre"
          style="
            width: 100%;
            padding: 10px;
            border-radius: 6px;
            border: 1.5px solid #444;
            background: #222;
            color: #fff;
          "
        />
        <input
          id="new-password2"
          type="password"
          placeholder="Yeni Şifre Tekrar"
          style="
            width: 100%;
            padding: 10px;
            border-radius: 6px;
            border: 1.5px solid #444;
            background: #222;
            color: #fff;
          "
        />
        <div
          id="password-modal-info"
          style="color: #ffd700; font-size: 0.98em; margin-bottom: 8px"
        ></div>
        <button
          id="save-password-btn"
          style="
            padding: 10px 0;
            border-radius: 6px;
            border: none;
            background: #ffd700;
            color: #222;
            font-weight: bold;
            font-size: 1.08em;
            cursor: pointer;
            width: 100%;
          "
        >
          Şifreyi Değiştir
        </button>
      </div>
    </div>

    <!-- EULA Modal -->
    <!-- EULA Modal -->
    <div
      id="eula-modal"
      style="
        display: none;
        position: fixed;
        left: 0;
        top: 0;
        width: 100vw;
        height: 100vh;
        background: #000a;
        z-index: 3000;
        align-items: center;
        justify-content: center;
      "
    >
      <div
        style="
          background: #232323;
          border-radius: 12px;
          padding: 32px 28px;
          min-width: 340px;
          max-width: 90vw;
          max-height: 90vh;
          color: #fff;
          box-shadow: 0 4px 32px #000a;
          display: flex;
          flex-direction: column;
          gap: 18px;
          align-items: center;
          position: relative;
          overflow: auto;
        "
      >
        <span
          style="
            position: absolute;
            right: 18px;
            top: 12px;
            cursor: pointer;
            font-size: 1.3em;
          "
          id="close-eula-modal"
          >&times;</span
        >
        <h2 style="margin: 0 0 12px 0">Kullanıcı Lisans Sözleşmesi (EULA)</h2>
        <div
          id="eula-content"
          style="
            text-align: left;
            color: #eee;
            font-size: 1em;
            max-width: 600px;
            max-height: 60vh;
            overflow: auto;
            scrollbar-width: none;
            -ms-overflow-style: none;
          "
        >
          <style>
            #eula-content::-webkit-scrollbar {
              display: none;
            }
          </style>
          <h1 style="font-size: 1.35em; margin-bottom: 0.2em">
            📜 End User License Agreement (EULA)
          </h1>
          <div style="font-size: 1em; color: #ffd700; margin-bottom: 0.5em">
            <b>Version:</b> 1.0<br />
            <b>Date:</b> April 30, 2025<br />
            <b>Owner:</b> Said Başara
          </div>
          <hr style="border: 0; border-top: 1px solid #444; margin: 10px 0" />
          <h2 style="font-size: 1.13em; color: #ffd700">1. Introduction</h2>
          <p>
            This End User License Agreement (“Agreement”) is a legal agreement
            between you (“User”) and Said Başara (“Licensor”) regarding the use
            of the software product (“Software”) developed and owned by the
            Licensor. By installing, copying, or otherwise using the Software,
            you agree to be bound by the terms of this Agreement.
          </p>
          <hr style="border: 0; border-top: 1px solid #444; margin: 10px 0" />
          <h2 style="font-size: 1.13em; color: #ffd700">2. License Grant</h2>
          <p>
            The Licensor grants you a limited, non-exclusive, non-transferable
            license to use the Software solely for personal, non-commercial
            purposes. The Software is <b>licensed, not sold</b>.
          </p>
          <hr style="border: 0; border-top: 1px solid #444; margin: 10px 0" />
          <h2 style="font-size: 1.13em; color: #ffd700">3. Restrictions</h2>
          <p>You may <b>not</b>:</p>
          <ul style="margin-left: 1.2em">
            <li>
              Copy, reproduce, distribute, or sublicense the Software in whole
              or in part;
            </li>
            <li>Reverse engineer, decompile, or disassemble the Software;</li>
            <li>Rent, lease, or sell the Software to third parties;</li>
            <li>Modify the Software or create derivative works based on it.</li>
          </ul>
          <hr style="border: 0; border-top: 1px solid #444; margin: 10px 0" />
          <h2 style="font-size: 1.13em; color: #ffd700">
            4. Intellectual Property
          </h2>
          <p>
            The Software and all associated intellectual property rights are and
            shall remain the sole property of Said Başara. This Agreement does
            not grant you any ownership rights in the Software.
          </p>
          <hr style="border: 0; border-top: 1px solid #444; margin: 10px 0" />
          <h2 style="font-size: 1.13em; color: #ffd700">
            5. Disclaimer of Warranty
          </h2>
          <p>
            The Software is provided “<b>AS IS</b>” without warranty of any
            kind. The Licensor makes no warranties, express or implied,
            including but not limited to merchantability or fitness for a
            particular purpose. The Licensor shall not be liable for any damages
            arising from the use or inability to use the Software.
          </p>
          <hr style="border: 0; border-top: 1px solid #444; margin: 10px 0" />
          <h2 style="font-size: 1.13em; color: #ffd700">6. Termination</h2>
          <p>
            This Agreement is effective until terminated. It will terminate
            automatically without notice if you fail to comply with any of its
            terms. Upon termination, you must immediately stop using and destroy
            all copies of the Software.
          </p>
          <hr style="border: 0; border-top: 1px solid #444; margin: 10px 0" />
          <h2 style="font-size: 1.13em; color: #ffd700">7. Governing Law</h2>
          <p>
            This Agreement shall be governed by and construed in accordance with
            the laws of the Republic of Turkey. Any disputes shall be subject to
            the exclusive jurisdiction of the courts of Istanbul (Anatolian
            Side), Turkey.
          </p>
          <hr style="border: 0; border-top: 1px solid #444; margin: 10px 0" />
          <h2 style="font-size: 1.13em; color: #ffd700">8. Contact</h2>
          <p>
            For any questions regarding this Agreement, please contact:<br />
            📧 <b>Email:</b>
            <a href="mailto:saidbasara7@gmail.com" style="color: #ffd700"
              >saidbasara7@gmail.com</a
            >
          </p>
          <hr style="border: 0; border-top: 1px solid #444; margin: 10px 0" />
          <h2 style="font-size: 1.13em; color: #ffd700">Acceptance</h2>
          <p>
            By installing or using the Software, you acknowledge that you have
            read, understood, and agreed to be bound by the terms and conditions
            of this Agreement.
          </p>
        </div>
      </div>
    </div>

    <!-- Ban Onay Modalı -->
    <div
      id="ban-user-modal"
      style="
        display: none;
        position: fixed;
        left: 0;
        top: 0;
        width: 100vw;
        height: 100vh;
        background: #000a;
        z-index: 4000;
        align-items: center;
        justify-content: center;
      "
    >
      <div
        style="
          background: #232323;
          border-radius: 12px;
          padding: 32px 28px;
          min-width: 320px;
          color: #fff;
          box-shadow: 0 4px 32px #000a;
          display: flex;
          flex-direction: column;
          gap: 18px;
          align-items: center;
          position: relative;
        "
      >
        <span
          style="
            position: absolute;
            right: 18px;
            top: 12px;
            cursor: pointer;
            font-size: 1.3em;
          "
          id="close-ban-user-modal"
          >&times;</span
        >
        <div
          id="ban-user-modal-title"
          style="font-size: 1.13em; text-align: center; margin-bottom: 8px"
        ></div>
        <div
          style="display: flex; gap: 14px; width: 100%; justify-content: center"
        >
          <button
            id="ban-user-yes-btn"
            style="
              padding: 10px 0;
              border-radius: 6px;
              border: 2px solid #e53935;
              background: transparent;
              color: #e53935;
              font-weight: bold;
              font-size: 1.08em;
              cursor: pointer;
              min-width: 100px;
            "
          >
            Evet
          </button>
          <button
            id="ban-user-no-btn"
            style="
              padding: 10px 0;
              border-radius: 6px;
              border: none;
              background: #ffd700;
              color: #222;
              font-weight: bold;
              font-size: 1.08em;
              cursor: pointer;
              min-width: 100px;
            "
          >
            Hayır
          </button>
        </div>
        <div
          id="ban-user-modal-info"
          style="
            color: #ffd700;
            font-size: 0.98em;
            margin-bottom: 8px;
            display: none;
          "
        ></div>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        // localStorage'da kullanıcı varsa otomatik giriş
        const savedUser = localStorage.getItem("pixelcar_user");
        if (savedUser) {
          const userData = JSON.parse(savedUser);
          showUserContent({ user: userData });
          // Giriş ekranlarını tamamen gizle
          document.getElementById("login-card").style.display = "none";
          document.getElementById("register-card").style.display = "none";
        } else {
          document.getElementById("login-card").style.display = "flex";
          document.getElementById("user-content").style.display = "none";
        }

        // Sohbet başlığına tarih ekle ve durum göstergesi ekle
        const chatHeader = document.getElementById("chat-header");
        function updateChatHeaderStatus(isLocked) {
          const chatStatusDot = document.getElementById("chat-status-dot");
          if (chatStatusDot) {
            chatStatusDot.style.color = isLocked ? "#e53935" : "#43a047";
          }
        }
        const now = new Date();
        const day = now.getDate().toString().padStart(2, "0");
        const month = (now.getMonth() + 1).toString().padStart(2, "0");
        const year = now.getFullYear();
        chatHeader.innerHTML = `Sohbet Kanalı
                <span id="chat-status-dot" style="font-size:1.45em; vertical-align:top; margin-left:8px; color:#43a047;">●</span>
                <span style="float:right; color:#ffd700; font-size:0.98em; font-weight:normal;">${day}.${month}.${year}</span>`;

        // Giriş formu submit işlemi
        const loginForm = document.getElementById("login-form");
        const loginUsernameInput = document.getElementById("login-username");
        const loginPasswordInput = document.getElementById("login-password");
        const loginCard = document.getElementById("login-card");
        const registerCard = document.getElementById("register-card");
        const errorDiv = document.getElementById("login-error");
        let loginStep = 1; // 1: kullanıcı adı, 2: şifre

        loginForm.addEventListener("submit", async function (e) {
          e.preventDefault();
          errorDiv.style.display = "none";
          const username = loginUsernameInput.value.trim();
          if (loginStep === 1) {
            // Kullanıcı adı kontrolü
            if (!username) {
              errorDiv.textContent = "Kullanıcı adı giriniz.";
              errorDiv.style.display = "block";
              return;
            }
            // Sunucudan kullanıcı var mı kontrol et
            try {
              const res = await fetch("/api/permission?username=" + encodeURIComponent(username));
              if (res.ok) {
                // Kullanıcı var, şifre kutusunu aç
                loginPasswordInput.style.display = "";
                loginPasswordInput.value = "";
                loginPasswordInput.focus();
                loginStep = 2;
                errorDiv.style.display = "none";
              } else {
                // Kullanıcı yok, kayıt ekranına yönlendir
                loginCard.style.display = "none";
                registerCard.style.display = "block";
                document.getElementById("register-username").value = username;
                loginStep = 1;
                loginPasswordInput.style.display = "none";
              }
            } catch {
              errorDiv.textContent = "Sunucuya ulaşılamadı.";
              errorDiv.style.display = "block";
            }
            return;
          }
          // loginStep === 2
          const password = loginPasswordInput.value;
          if (!password) {
            errorDiv.textContent = "Şifre giriniz.";
            errorDiv.style.display = "block";
            return;
          }
          try {
            const res = await fetch("/api/login-or-register", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ username, password }),
            });
            const data = await res.json();
            if (res.ok) {
              // Giriş başarılı
              localStorage.setItem("pixelcar_user", JSON.stringify(data.user));
              showUserContent(data);
              loginCard.style.display = "none";
              registerCard.style.display = "none";
              loginStep = 1;
              loginPasswordInput.style.display = "none";
            } else {
              errorDiv.textContent = data.error || "Giriş başarısız";
              errorDiv.style.display = "block";
            }
          } catch (err) {
            errorDiv.textContent = "Sunucuya bağlanılamadı";
            errorDiv.style.display = "block";
          }
        });

        // Kullanıcı adı kutusunda değişiklik olursa şifre kutusunu gizle ve adımı sıfırla
        loginUsernameInput.addEventListener("input", function () {
          loginPasswordInput.style.display = "none";
          loginStep = 1;
        });

        const registerForm = document.getElementById("register-form");
        const registerErrorDiv = document.getElementById("register-error");
        const editUsernameInput = document.getElementById("edit-username");
        const registerUsernameInput =
          document.getElementById("register-username");
        const tagInput = document.getElementById("edit-tag");
        const tagEditInfo = document.getElementById("tag-edit-info");

        const backToLoginBtn = document.getElementById("back-to-login-btn");
        if (backToLoginBtn) {
          backToLoginBtn.addEventListener("click", function () {
            registerCard.style.display = "none";
            loginCard.style.display = "flex";
          });
        }

        function updateUserCard(data) {
          const displayName =
            data.user.displayName ||
            data.user.display_name ||
            data.user.username;
          document.getElementById("user-card-name").textContent = displayName;
          document.getElementById("user-card-username").textContent =
            "@" + data.user.username;
          let avatarSrc =
            data.user.avatar ||
            `https://ui-avatars.com/api/?name=${encodeURIComponent(
              data.user.tag || ""
            )}&background=222&color=fff&size=96`;
          document.getElementById("user-avatar").src = avatarSrc;
        }

        function updateSideMenuUsername(username) {
          const sideMenu = document.getElementById("side-menu");
          const userMenuLink = document.getElementById("user-menu-link");
          if (sideMenu && userMenuLink) {
            userMenuLink.textContent = username;
          }
        }

        function showUserPanel() {
          const userCard = document.getElementById("user-card");
          userCard.style.display = "";
        }
        function hideUserPanel() {
          const userCard = document.getElementById("user-card");
          userCard.style.display = "none";
        }

        document
          .getElementById("user-menu-link")
          .addEventListener("click", function (e) {
            e.preventDefault();
            showUserPanel();
            const galleryPanel = document.getElementById("gallery-panel");
            if (galleryPanel) galleryPanel.remove();
          });

        function showUserContent(data) {
          document.getElementById("login-card").style.display = "none";
          document.getElementById("register-card").style.display = "none";
          document.getElementById("user-content").style.display = "block";
          updateUserCard(data);
          updateSideMenuUsername(
            data.user.displayName ||
              data.user.display_name ||
              data.user.username
          );
          const username = data.user.username;
          fetch("/api/permission?username=" + encodeURIComponent(username))
            .then((r) => r.json())
            .then((res) => {
              if (res && typeof res.authority !== "undefined") {
                // localStorage'daki user objesini güncelle
                let user = JSON.parse(
                  localStorage.getItem("pixelcar_user") || "{}"
                );
                user.authority = res.authority;
                localStorage.setItem("pixelcar_user", JSON.stringify(user));
              }
            });
        }

        function hideUserContent() {
          document.getElementById("user-content").style.display = "none";
          document.getElementById("login-card").style.display = "flex";
        }

        registerForm.addEventListener("submit", async function (e) {
          e.preventDefault();
          registerErrorDiv.style.display = "none";
          const username = document.getElementById("register-username").value;
          const email = document.getElementById("register-email").value;
          const password = document.getElementById("register-password").value;
          const password2 = document.getElementById("register-password2").value;
          const tag = document.getElementById("register-tag").value;
          const registerEulaCheckbox = document.getElementById(
            "register-eula-checkbox"
          );
          const registerTosCheckbox = document.getElementById(
            "register-tos-checkbox"
          );
          if (password !== password2) {
            registerErrorDiv.textContent = "Şifreler eşleşmiyor!";
            registerErrorDiv.style.display = "block";
            return;
          }
          if (!tag || tag.length > 2) {
            registerErrorDiv.textContent = "Etiket en fazla 2 karakter olmalı!";
            registerErrorDiv.style.display = "block";
            return;
          }
          // EULA ve TOS onay kontrolü
          if (
            !(
              registerEulaCheckbox &&
              registerEulaCheckbox.checked &&
              registerTosCheckbox &&
              registerTosCheckbox.checked
            )
          ) {
            registerErrorDiv.textContent =
              "Kayıt olmak için sözleşmeleri kabul etmelisiniz!";
            registerErrorDiv.style.display = "block";
            return;
          }
          try {
            const res = await fetch("/api/register", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ username, password, email, tag }),
            });
            const data = await res.json();
            if (res.ok) {
              localStorage.setItem("pixelcar_user", JSON.stringify(data.user));
              showUserContent(data);
              document.getElementById("login-card").style.display = "none";
              document.getElementById("register-card").style.display = "none";
            } else {
              registerErrorDiv.textContent = data.error || "Kayıt başarısız";
              registerErrorDiv.style.display = "block";
            }
          } catch (err) {
            registerErrorDiv.textContent = "Sunucuya bağlanılamadı";
            registerErrorDiv.style.display = "block";
          }
        });

        // Kullanıcı adı kutusunda büyük harf ve boşluk engelle (profil düzenle)
        editUsernameInput.addEventListener("input", function () {
          let val = editUsernameInput.value;
          // Sadece İngilizce harf ve rakam, küçük harfe çevir, boşluk yok
          let newVal = val.replace(/[^a-zA-Z0-9]/g, "").toLowerCase();
          if (val !== newVal) {
            const start = editUsernameInput.selectionStart;
            const end = editUsernameInput.selectionEnd;
            editUsernameInput.value = newVal;
            editUsernameInput.setSelectionRange(
              start - (val.length - newVal.length),
              end - (val.length - newVal.length)
            );
          }
        });
        // Otomatik doldurma/autofill engelle (profil düzenle)
        editUsernameInput.setAttribute("autocomplete", "new-password");
        editUsernameInput.setAttribute("autocorrect", "off");
        editUsernameInput.setAttribute("autocapitalize", "off");
        editUsernameInput.setAttribute("spellcheck", "false");
        editUsernameInput.setAttribute("inputmode", "text");
        editUsernameInput.setAttribute("tabindex", "1");
        editUsernameInput.addEventListener("focus", function () {
          editUsernameInput.setAttribute("autocomplete", "new-password");
        });
        editUsernameInput.addEventListener("mousedown", function () {
          editUsernameInput.setAttribute("autocomplete", "new-password");
        });
        // Kayıt olurken kullanıcı adı kutusunda SADECE İngilizce harf ve büyük harf serbest, boşluk yok
        registerUsernameInput.addEventListener("input", function () {
          let val = registerUsernameInput.value;
          let newVal = val.replace(/[^a-zA-Z]/g, "");
          if (val !== newVal) {
            const start = registerUsernameInput.selectionStart;
            const end = registerUsernameInput.selectionEnd;
            registerUsernameInput.value = newVal;
            registerUsernameInput.setSelectionRange(
              start - (val.length - newVal.length),
              end - (val.length - newVal.length)
            );
          }
        });

        // Giriş ekranında kullanıcı adı/e-posta kutusunda boşluk ve Türkçe karakter engelle
        loginUsernameInput.addEventListener("input", function () {
          let val = loginUsernameInput.value;
          let newVal = val.replace(/[^a-zA-Z0-9@.]/g, "");
          if (val !== newVal) {
            const start = loginUsernameInput.selectionStart;
            const end = loginUsernameInput.selectionEnd;
            loginUsernameInput.value = newVal;
            loginUsernameInput.setSelectionRange(
              start - (val.length - newVal.length),
              end - (val.length - newVal.length)
            );
          }
        });

        // Tag input: sadece büyük harf ve rakam, boşluk yok, max 2 karakter
        tagInput.addEventListener("input", function () {
          let val = tagInput.value;
          // Sadece İngilizce harf ve rakam, büyük harfe çevir, max 2 karakter
          let newVal = val
            .replace(/[^A-Za-z0-9]/g, "")
            .toUpperCase()
            .slice(0, 2);
          if (val !== newVal) {
            const start = tagInput.selectionStart;
            const end = tagInput.selectionEnd;
            tagInput.value = newVal;
            tagInput.setSelectionRange(
              start - (val.length - newVal.length),
              end - (val.length - newVal.length)
            );
          }
        });

        // User-card'a sağ veya sol tıklayınca çıkış menüsünü aç/kapat
        const userCard = document.getElementById("user-card");
        const logoutMenu = document.getElementById("logout-menu");
        let logoutMenuVisible = false;
        let hideTimeout;

        // Menü yumuşak gelsin ve mouse user-card'dan çıkınca kaybolsun
        function showLogoutMenu(x, y) {
          logoutMenu.style.display = "block";
          logoutMenu.style.opacity = "1";
          logoutMenu.style.left = x + "px";
          logoutMenu.style.top = y + "px";
          logoutMenuVisible = true;
          clearTimeout(hideTimeout);
        }
        function hideLogoutMenu() {
          logoutMenu.style.opacity = "0";
          logoutMenuVisible = false;
          hideTimeout = setTimeout(() => {
            if (!logoutMenuVisible) logoutMenu.style.display = "none";
          }, 120);
        }

        userCard.addEventListener("contextmenu", function (e) {
          e.preventDefault();
          showLogoutMenu(e.clientX, e.clientY);
        });
        userCard.addEventListener("click", function (e) {
          showLogoutMenu(e.clientX, e.clientY);
          e.stopPropagation();
        });

        // Mouse user-card veya menüden çıkınca menüyü gizle
        userCard.addEventListener("mouseleave", function (e) {
          // Eğer mouse logoutMenu'nun üstüne gidiyorsa küçülmeyi engelle
          const toElement = e.relatedTarget || e.toElement;
          if (!logoutMenu.contains(toElement)) {
            userCard.classList.remove("user-card-hover-fix");
            hideLogoutMenu();
          } else {
            // Menüye geçerken hover efektini sabitle
            userCard.classList.add("user-card-hover-fix");
          }
        });
        logoutMenu.addEventListener("mouseenter", function () {
          clearTimeout(hideTimeout);
          logoutMenuVisible = true;
          userCard.classList.add("user-card-hover-fix");
        });
        logoutMenu.addEventListener("mouseleave", function (e) {
          // Eğer mouse userCard'ın üstüne gidiyorsa küçülmeyi engelle
          const toElement = e.relatedTarget || e.toElement;
          if (!userCard.contains(toElement)) {
            userCard.classList.remove("user-card-hover-fix");
            hideLogoutMenu();
          }
        });

        // Sayfanın başka yerine tıklanınca çıkış menüsünü kapat
        document.addEventListener("click", function () {
          hideLogoutMenu();
        });

        document
          .getElementById("logout-btn")
          .addEventListener("click", function (e) {
            localStorage.removeItem("pixelcar_user");
            hideUserContent();
            document.getElementById("login-card").style.display = "flex";
            hideLogoutMenu();
            e.stopPropagation();
          });

        const profileEditBtn = document.getElementById("profile-edit-btn");
        const profileEditModal = document.getElementById("profile-edit-modal");
        const closeProfileEdit = document.getElementById("close-profile-edit");
        const profileEditInfo = document.getElementById("profile-edit-info");
        const saveProfileBtn = document.getElementById("save-profile-btn");
        const editDisplayNameInput =
          document.getElementById("edit-displayname");
        const displayNameEditInfo = document.getElementById(
          "displayname-edit-info"
        );
        const passwordModal = document.getElementById("password-modal");
        const closePasswordModal = document.getElementById(
          "close-password-modal"
        );
        const changePasswordBtn = document.getElementById(
          "change-password-btn"
        );
        const savePasswordBtn = document.getElementById("save-password-btn");
        const passwordModalInfo = document.getElementById(
          "password-modal-info"
        );
        const currentPasswordInput =
          document.getElementById("current-password");
        const newPasswordInput = document.getElementById("new-password");
        const newPassword2Input = document.getElementById("new-password2");

        // Profil düzenle aç
        profileEditBtn.addEventListener("click", function (e) {
          e.stopPropagation();
          profileEditModal.style.display = "flex";
          const user = JSON.parse(
            localStorage.getItem("pixelcar_user") || "{}"
          );
          editUsernameInput.value = user.username || "";
          editDisplayNameInput.value = user.displayName || "";
          tagInput.value = user.tag || "";
          profileEditInfo.textContent = "";
          displayNameEditInfo.textContent = "";
          tagEditInfo.textContent = "";

          // "Hesabı Sil" butonunu admin için gizle
          const deleteAccountBtn =
            document.getElementById("delete-account-btn");
          if (deleteAccountBtn) {
            if (user.username && user.username.toLowerCase() === "admin") {
              deleteAccountBtn.style.display = "none";
            } else {
              deleteAccountBtn.style.display = "";
            }
          }

          let usernameChangeAllowed = true;

          // Butonun ilk durumu: değişiklik yoksa disable
          function updateSaveProfileBtnState() {
            const currentUsername = editUsernameInput.value.trim();
            const currentDisplayName = editDisplayNameInput.value.trim();
            const currentTag = tagInput.value.trim();
            const usernameChanged = currentUsername !== (user.username || "");
            const displayNameChanged =
              currentDisplayName !== (user.displayName || "");
            const tagChanged = currentTag !== (user.tag || "");
            // Kullanıcı adı alanı disable ise sadece görünen ad ve tag değişikliği kontrol edilir
            if (
              (editUsernameInput.disabled || !usernameChangeAllowed) &&
              !displayNameChanged &&
              !tagChanged
            ) {
              saveProfileBtn.disabled = true;
              saveProfileBtn.style.background = "#888";
              saveProfileBtn.style.color = "#ccc";
              saveProfileBtn.style.cursor = "not-allowed";
            } else if (
              !editUsernameInput.disabled &&
              !usernameChanged &&
              !displayNameChanged &&
              !tagChanged
            ) {
              saveProfileBtn.disabled = true;
              saveProfileBtn.style.background = "#888";
              saveProfileBtn.style.color = "#ccc";
              saveProfileBtn.style.cursor = "not-allowed";
            } else {
              saveProfileBtn.disabled = false;
              saveProfileBtn.style.background = "#ffd700";
              saveProfileBtn.style.color = "#222";
              saveProfileBtn.style.cursor = "pointer";
            }
          }

          editUsernameInput.addEventListener(
            "input",
            updateSaveProfileBtnState
          );
          editDisplayNameInput.addEventListener(
            "input",
            updateSaveProfileBtnState
          );
          tagInput.addEventListener("input", updateSaveProfileBtnState);

          // Kullanıcı adı kalan süre
          fetch(
            `/api/profile-edit-remaining?username=${encodeURIComponent(
              user.username
            )}`
          )
            .then((r) => r.json())
            .then((data) => {
              if (data.remaining && data.remaining > 0) {
                // Sadece gün olarak göster
                const days = Math.ceil(data.remaining / 86400);
                profileEditInfo.textContent = `Kullanıcı adını tekrar değiştirmek için kalan süre: ${days} gün`;
                editUsernameInput.disabled = true;
                usernameChangeAllowed = false;
              } else {
                profileEditInfo.textContent = "";
                editUsernameInput.disabled = false;
                usernameChangeAllowed = true;
              }
              updateSaveProfileBtnState();
            });
          // Görünen ad kalan hak
          fetch(
            `/api/displayname-edit-remaining?username=${encodeURIComponent(
              user.username
            )}`
          )
            .then((r) => r.json())
            .then((data) => {
              if (data.remaining === 0) {
                displayNameEditInfo.textContent = "";
                editDisplayNameInput.disabled = false;
              } else if (data.remaining > 0) {
                displayNameEditInfo.textContent = `Bugün ${
                  3 - data.remaining
                }/3 kez değiştirdiniz.`;
                editDisplayNameInput.disabled = false;
              }
              if (data.remaining <= 0 && data.count >= 3) {
                displayNameEditInfo.textContent =
                  "Bugün görünen adınızı 3 kez değiştirdiniz. Yarın tekrar deneyebilirsiniz.";
                editDisplayNameInput.disabled = true;
              }
              updateSaveProfileBtnState();
            });
          // Tag kalan hak
          fetch(
            `/api/tag-edit-remaining?username=${encodeURIComponent(
              user.username
            )}`
          )
            .then((r) => r.json())
            .then((data) => {
              if (data.remaining === 0) {
                tagEditInfo.textContent = "";
                tagInput.disabled = false;
              } else if (data.remaining > 0) {
                tagEditInfo.textContent = `Bugün ${
                  3 - data.remaining
                }/3 kez değiştirdiniz.`;
                tagInput.disabled = false;
              }
              if (data.remaining <= 0 && data.count >= 3) {
                tagEditInfo.textContent =
                  "Bugün kart etiketinizi 3 kez değiştirdiniz. Yarın tekrar deneyebilirsiniz.";
                tagInput.disabled = true;
              }
              updateSaveProfileBtnState();
            });
        });
        closeProfileEdit.addEventListener("click", function () {
          profileEditModal.style.display = "none";
        });

        // Profil kaydet
        saveProfileBtn.addEventListener("click", async function () {
          const user = JSON.parse(
            localStorage.getItem("pixelcar_user") || "{}"
          );
          const newUsername = editUsernameInput.value.trim();
          const newDisplayName = editDisplayNameInput.value.trim();
          const newTag = tagInput.value.trim();
          // Kullanıcı adı kalan süre kontrolü
          if (
            typeof usernameChangeAllowed !== "undefined" &&
            (editUsernameInput.disabled || !usernameChangeAllowed)
          ) {
            if (newUsername !== user.username) {
              profileEditInfo.textContent =
                "Bir şeyler ters gitti. Kullanıcı adını şu anda değiştiremezsiniz.";
              return;
            }
          }
          if (!newUsername) {
            profileEditInfo.textContent = "Kullanıcı adı boş olamaz!";
            return;
          }
          if (newDisplayName.length > 15) {
            displayNameEditInfo.textContent =
              "Görünen ad en fazla 15 karakter olmalı!";
            return;
          }
          if (!newTag) {
            tagEditInfo.textContent = "Etiket boş bırakılamaz!";
            return;
          }
          if (newTag.length > 2) {
            tagEditInfo.textContent = "Etiket en fazla 2 harf olmalı!";
            return;
          }
          // Kullanıcı adı, görünen ad ve tag değişikliği birlikte gönderiliyor
          const res = await fetch("/api/change-profile", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              oldUsername: user.username,
              newUsername,
              newDisplayName,
              newTag,
            }),
          });
          const data = await res.json();
          if (res.ok) {
            user.username = newUsername;
            user.displayName = newDisplayName;
            user.tag = newTag;
            localStorage.setItem("pixelcar_user", JSON.stringify(user));
            profileEditModal.style.display = "none";
            location.reload();
          } else {
            if (data.usernameError)
              profileEditInfo.textContent = data.usernameError;
            if (data.displayNameError)
              displayNameEditInfo.textContent = data.displayNameError;
            if (data.tagError) tagEditInfo.textContent = data.tagError;
            if (!data.usernameError && !data.displayNameError && !data.tagError)
              profileEditInfo.textContent = data.error || "Bir hata oluştu.";
          }
        });

        // Şifre değiştir modalı aç
        changePasswordBtn.addEventListener("click", function (e) {
          e.stopPropagation();
          passwordModal.style.display = "flex";
          passwordModalInfo.textContent = "";
          currentPasswordInput.value = "";
          newPasswordInput.value = "";
          newPassword2Input.value = "";
        });
        closePasswordModal.addEventListener("click", function () {
          passwordModal.style.display = "none";
        });

        // Şifre değiştir
        let lastPasswordChange = 0;
        savePasswordBtn.addEventListener("click", async function () {
          const now = Date.now();
          if (now - lastPasswordChange < 10000) {
            // 10 saniye beklet
            passwordModalInfo.style.color = "#ffd700";
            passwordModalInfo.textContent =
              "Çok sık denediniz, lütfen biraz bekleyin.";
            return;
          }
          lastPasswordChange = now;
          const user = JSON.parse(
            localStorage.getItem("pixelcar_user") || "{}"
          );
          const currentPassword = currentPasswordInput.value;
          const newPassword = newPasswordInput.value;
          const newPassword2 = newPassword2Input.value;
          if (!currentPassword || !newPassword || !newPassword2) {
            passwordModalInfo.textContent = "Tüm alanları doldurun!";
            return;
          }
          if (newPassword !== newPassword2) {
            passwordModalInfo.textContent = "Yeni şifreler eşleşmiyor!";
            return;
          }
          const res = await fetch("/api/change-password", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              username: user.username,
              currentPassword,
              newPassword,
            }),
          });
          const data = await res.json();
          if (res.ok) {
            passwordModalInfo.style.color = "#0f0";
            passwordModalInfo.textContent = "Şifre başarıyla değiştirildi!";
            setTimeout(() => {
              passwordModal.style.display = "none";
            }, 1200);
          } else {
            passwordModalInfo.style.color = "#ffd700";
            passwordModalInfo.textContent = data.error || "Bir hata oluştu.";
          }
        });

        // Modal dışına tıklayınca kapat
        window.addEventListener("click", function (e) {
          if (e.target === profileEditModal)
            profileEditModal.style.display = "none";
          if (e.target === passwordModal) passwordModal.style.display = "none";
        });

        const chatMessages = document.getElementById("chat-messages");
        const chatForm = document.getElementById("chat-form");
        const chatInput = document.getElementById("chat-input");
        const typingIndicator = document.getElementById("typing-indicator");
        const MAX_CHAT_LEN = 100;

        chatInput.setAttribute("maxlength", MAX_CHAT_LEN);

        let chatLocked = false; // Sohbet kilitli mi?
        let typingTimeout = null;
        let lastTypingSent = 0;

        // Yazıyor ve online bilgisini backend'e gönder (1 dakika online süresi için)
        chatInput.addEventListener("input", function () {
          const user = JSON.parse(
            localStorage.getItem("pixelcar_user") || "{}"
          );
          if (!user.username) return;
          const now = Date.now();
          // Her input'ta online bildirimi ve yazıyor bildirimi gönder
          fetch("/api/typing", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              username: user.username,
              displayName:
                user.displayName || user.display_name || user.username,
              onlineTimeout: 60000 // 1 dakika (ms)
            }),
          });
          lastTypingSent = now;

          // Karakter sayacı
          const len = chatInput.value.length;
          let color = "#ffd700";
          if (len >= 95) color = "#e53935";
          const charCounterSpan = document.getElementById("char-counter-span");
          if (charCounterSpan) {
            if (len >= 90) {
              charCounterSpan.textContent = `${len}/${MAX_CHAT_LEN}`;
              charCounterSpan.style.color = color;
              charCounterSpan.style.opacity = "1";
            } else {
              charCounterSpan.textContent = "";
              charCounterSpan.style.opacity = "1";
            }
          }
        });

        // Ayrıca, kullanıcı online kalmak için her 30 saniyede bir heartbeat göndersin
        function sendOnlineHeartbeat() {
          const user = JSON.parse(localStorage.getItem("pixelcar_user") || "{}");
          if (user.username) {
            fetch("/api/typing", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                username: user.username,
                displayName: user.displayName || user.display_name || user.username,
                onlineTimeout: 60000 // 1 dakika (ms)
              }),
            });
          }
        }
        setInterval(sendOnlineHeartbeat, 30000); // 30 saniyede bir

        // Yazıyor bilgisini backend'den çek ve göster
        async function fetchTypingUsers() {
          // 1. Yazıyor bilgisini çek
          let typingData = { typing: [] };
          try {
            const res = await fetch("/api/typing");
            typingData = await res.json();
          } catch {}
          // 2. Online kullanıcı sayısını çek
          let onlineCount = 0;
          try {
            const usersRes = await fetch("/api/online-users");
            const usersData = await usersRes.json();
            // /api/online-users dönen veri: { count, users }
            if (usersData && typeof usersData.count === "number") {
              onlineCount = usersData.count;
            } else if (Array.isArray(usersData)) {
              onlineCount = usersData.length;
            }
          } catch {}
          // 3. DOM'a yaz
          const onlineCountSpan = document.getElementById("online-count");
          if (onlineCountSpan) {
            onlineCountSpan.textContent = onlineCount > 0 ? `${onlineCount} online` : "";
            onlineCountSpan.style.opacity = "1";
          }
          const typingUsersSpan = document.getElementById("typing-users-span");
          if (typingUsersSpan) {
            // Kendi kullanıcıyı hariç tut
            let user = {};
            try {
              user = JSON.parse(localStorage.getItem("pixelcar_user") || "{}");
            } catch {}
            const others = (typingData.typing || []).filter(
              (u) => u.username !== user.username
            );
            if (others.length > 0) {
              const names = others.map((u) => u.displayName || u.username);
              typingUsersSpan.textContent = `${names.join(", ")} yazıyor...`;
              typingUsersSpan.style.opacity = "1";
            } else {
              typingUsersSpan.textContent = "";
              typingUsersSpan.style.opacity = "1";
            }
          }
        }
        setInterval(fetchTypingUsers, 1000);
        fetchTypingUsers();

        // Mesajları sunucudan çek ve ekrana bas
        async function fetchAndRenderMessages() {
          const res = await fetch("/api/chat-messages");
          const data = await res.json();
          chatLocked = !!data.chatLocked;
          updateChatHeaderStatus(chatLocked);
          const isAtBottom =
            chatMessages.scrollTop + chatMessages.clientHeight >=
            chatMessages.scrollHeight - 10;
          chatMessages.innerHTML = "";
          const user = JSON.parse(
            localStorage.getItem("pixelcar_user") || "{}"
          );
          const isMod = user && user.authority === 2;
          (data.messages || []).forEach((msg, idx, u) => {
            const avatarUrl =
              msg.avatar ||
              `https://ui-avatars.com/api/?name=${encodeURIComponent(
                msg.tag || ""
              )}&background=222&color=fff&size=32`;
            let timeStr = "";
            if (msg.time) {
              const d = new Date(msg.time);
              const h = d.getHours().toString().padStart(2, "0");
              const m = d.getMinutes().toString().padStart(2, "0");
              timeStr = `${h}:${m}`;
            }
            const isOwnMsg = user && msg.username === user.username;
            const showDeleteBtn = isMod || isOwnMsg;
            // Kullanıcı adı admin ise siyah, kendi mesajı ise beyaz, diğerleri varsayılan
            let usernameStyle = "";
            let textStyle = "";
            if (msg.username && msg.username.toLowerCase() === "admin") {
              usernameStyle =
                "color:#111; background:#ffd700; border-radius:4px; padding:1px 6px;";
              textStyle = "font-weight:bold;";
            } else if (isOwnMsg) {
              usernameStyle = "color:#fff; border-radius:4px; 6px;";
            }
            const msgDiv = document.createElement("div");
            msgDiv.className = "chat-message-row";
            msgDiv.style.display = "flex";
            msgDiv.style.alignItems = "center";
            msgDiv.innerHTML = `
                        <img src="${avatarUrl}" alt="avatar" class="chat-avatar">
                        <span class="chat-user" style="margin-left:4px;${usernameStyle}"><b>${
              msg.displayName
            }</b></span>
                        <span class="chat-text" style="margin-left:6px;${textStyle}">${
              msg.text
            }</span>
                        <span style="flex:1"></span>
                        <span class="chat-time" style="color:#bbb; font-size:0.93em; margin-left:10px; min-width:38px; text-align:right;">${timeStr}</span>
                        ${
                          showDeleteBtn
                            ? `<button class="chat-delete-btn" data-msg-idx="${idx}" style="margin-left:8px; background:#c00; color:#fff; border:none; border-radius:4px; padding:2px 8px; cursor:pointer;">Sil</button>`
                            : ""
                        }
                    `;
            chatMessages.appendChild(msgDiv);
          });

          // Silme butonlarına event ekle (kendi mesajı veya yetkili kullanıcılar için)
          document.querySelectorAll(".chat-delete-btn").forEach((btn) => {
            btn.addEventListener("click", async function (e) {
              const idx = parseInt(btn.getAttribute("data-msg-idx"));
              // Mesajı silmek için API çağrısı
              const res = await fetch("/api/delete-chat-message", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ idx, username: user.username }),
              });
              if (res.ok) {
                fetchAndRenderMessages();
              } else {
                showAlert("Mesaj silinemedi.");
              }
            });
          });
          if (isAtBottom) {
            chatMessages.scrollTop = chatMessages.scrollHeight;
          }
        }
        // Uyarı mesajı göstermek için fonksiyon (kırmızı, 5 saniye)
        function showAlert(msg) {
          let alertDiv = document.getElementById("custom-alert");
          if (!alertDiv) {
            alertDiv = document.createElement("div");
            alertDiv.id = "custom-alert";
            alertDiv.style.position = "fixed";
            alertDiv.style.top = "32px";
            alertDiv.style.left = "50%";
            alertDiv.style.transform = "translateX(-50%)";
            alertDiv.style.background = "#c00";
            alertDiv.style.color = "#fff";
            alertDiv.style.padding = "14px 32px";
            alertDiv.style.borderRadius = "8px";
            alertDiv.style.fontSize = "1.08em";
            alertDiv.style.fontWeight = "bold";
            alertDiv.style.zIndex = "9999";
            alertDiv.style.boxShadow = "0 4px 24px #0008";
            alertDiv.style.transition = "opacity 0.3s";
            alertDiv.style.opacity = "0.98";
            document.body.appendChild(alertDiv);
          }
          alertDiv.textContent = msg;
          alertDiv.style.display = "block";
          alertDiv.style.opacity = "0.98";
          clearTimeout(alertDiv._timeout);
          alertDiv._timeout = setTimeout(() => {
            alertDiv.style.opacity = "0";
            setTimeout(() => {
              alertDiv.style.display = "none";
            }, 400);
          }, 5000);
        }

        // Mesaj gönderme
        chatForm.addEventListener("submit", async function (e) {
          e.preventDefault();
          const msg = chatInput.value.trim();
          if (!msg) return;
          if (msg.length > MAX_CHAT_LEN) {
            showAlert("Mesaj en fazla 100 karakter olabilir.");
            return;
          }
          const user = JSON.parse(
            localStorage.getItem("pixelcar_user") || "{}"
          );
          const tag = user.tag || "";
          const username = user.username || "Kullanıcı";
          const avatar = user.avatar || "";
          const msgLower = msg.trim().toLowerCase();

          // / ile başlayan hiçbir komut chate gönderilmesin
          if (msg.startsWith("/")) {
            // /per komutu
            if (msgLower === "/per") {
              let yetki = user.authority;
              if (
                yetki === undefined ||
                yetki === null ||
                yetki === "" ||
                yetki === false
              ) {
                const storedUser = localStorage.getItem("pixelcar_user");
                if (storedUser) {
                  try {
                    const parsed = JSON.parse(storedUser);
                    yetki = parsed.authority;
                  } catch {}
                }
              }
              showAlert(
                "Yetki seviyeniz: " +
                  (yetki !== undefined && yetki !== null && yetki !== ""
                    ? yetki
                    : "yok")
              );
              chatInput.value = "";
              return;
            }
            // /chat off ve /chat on komutları
            if (msgLower === "/chat off" || msgLower === "/chat on") {
              if (String(user.authority) !== "2" && user.authority !== 2) {
                showAlert("Bu komutu sadece yetkililer kullanabilir.");
                return;
              }
              // Komutun etkisi için sunucuya gönder (chate eklenmeyecek)
              await fetch("/api/chat-message", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ username, tag, avatar, text: msg }),
              });
              if (msgLower === "/chat off") {
                showAlert("Chat kapalı");
                updateChatHeaderStatus(true);
              } else if (msgLower === "/chat on") {
                showAlert("Chat açık");
                updateChatHeaderStatus(false);
              }
              chatInput.value = "";
              fetchAndRenderMessages();
              return;
            }
            // /users komutu
            if (msgLower === "/users") {
              // Sadece yetki 2 olanlar için
              if (String(user.authority) !== "2" && user.authority !== 2) {
                showAlert("Bu komutu sadece yetkililer kullanabilir.");
                return;
              }
              const res = await fetch("/api/chat-message", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ username, tag, avatar, text: msg }),
              });
              const data = await res.json();
              if (res.ok && data.download) {
                // Dosyayı otomatik indir
                const a = document.createElement("a");
                a.href = data.download;
                a.download = "users_dump.txt";
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                showAlert("Kullanıcı listesi indirildi.");
              } else {
                showAlert(data.error || "Kullanıcı listesi indirilemedi.");
              }
              chatInput.value = "";
              return;
            }
            // /ban <kullanıcı> komutu
            if (msgLower.startsWith("/ban")) {
              if (String(user.authority) !== "2" && user.authority !== 2) {
                showAlert("Bu komutu sadece yetkililer kullanabilir.");
                return;
              }
              const parts = msg.trim().split(/\s+/);
              if (parts.length < 2 || !parts[1]) {
                showAlert("Banlanacak kullanıcı adını boş bıraktınız.");
                return;
              }
              const target = parts[1];
              if (!/^[a-zA-Z0-9]+$/.test(target)) {
                showAlert("Geçersiz kullanıcı adı.");
                return;
              }
              // Kullanıcı var mı kontrolü
              try {
                const checkRes = await fetch(
                  "/api/permission?username=" + encodeURIComponent(target)
                );
                if (!checkRes.ok) {
                  showAlert("Böyle bir kullanıcı yok.");
                  return;
                }
              } catch {
                showAlert("Böyle bir kullanıcı yok.");
                return;
              }
              banTargetUser = target;
              banUserModalTitle.textContent = `${target} banlansın mı?`;
              banUserModalInfo.style.display = "none";
              banUserModal.style.display = "flex";
              chatInput.value = "";
              return;
            }
            // /clear komutu
            if (msgLower === "/clear") {
              if (String(user.authority) !== "2" && user.authority !== 2) {
                showAlert("Bu komutu sadece yetkililer kullanabilir.");
                chatInput.value = "";
                return;
              }
              try {
                const res = await fetch("/api/clear-chat", {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({ username }),
                });
                if (res.ok) {
                  showAlert("Tüm sohbet mesajları silindi.");
                  fetchAndRenderMessages();
                } else {
                  showAlert("Mesajlar silinemedi.");
                }
              } catch {
                showAlert("Sunucuya ulaşılamadı.");
              }
              chatInput.value = "";
              return;
            }
            // Diğer tüm / ile başlayan komutlar için de chate gönderme
            chatInput.value = "";
            return;
          }

          if (
            chatLocked &&
            String(user.authority) !== "2" &&
            user.authority !== 2
          ) {
            showAlert(
              "Sohbet şu anda kapalı. Sadece yetkililer mesaj atabilir."
            );
            return;
          }

          await fetch("/api/chat-message", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ username, tag, avatar, text: msg }),
          });
          chatInput.value = "";
          fetchAndRenderMessages();
        });

        // Ban modal referansları
        const banUserModal = document.getElementById("ban-user-modal");
        const banUserModalTitle = document.getElementById(
          "ban-user-modal-title"
        );
        const banUserYesBtn = document.getElementById("ban-user-yes-btn");
        const banUserNoBtn = document.getElementById("ban-user-no-btn");
        const closeBanUserModal = document.getElementById(
          "close-ban-user-modal"
        );
        const banUserModalInfo = document.getElementById("ban-user-modal-info");
        let banTargetUser = null;

        // Ban modalı butonları
        if (banUserNoBtn) {
          banUserNoBtn.onclick = function () {
            banUserModal.style.display = "none";
            banTargetUser = null;
          };
        }
        if (closeBanUserModal) {
          closeBanUserModal.onclick = function () {
            banUserModal.style.display = "none";
            banTargetUser = null;
          };
        }
        if (banUserYesBtn) {
          banUserYesBtn.onclick = async function () {
            if (!banTargetUser) return;
            banUserYesBtn.disabled = true;
            banUserModalInfo.style.display = "none";
            // Sunucuya silme isteği gönder
            const res = await fetch("/api/delete-account", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                username: banTargetUser,
                password: "__admin_ban__",
              }), // password dummy, backend ignore etmeli
            });
            if (res.ok) {
              banUserModalInfo.style.display = "block";
              banUserModalInfo.style.color = "#0f0";
              banUserModalInfo.textContent = "Kullanıcı başarıyla silindi.";
              setTimeout(() => {
                banUserModal.style.display = "none";
                banUserModalInfo.style.display = "none";
                banTargetUser = null;
                banUserYesBtn.disabled = false;
              }, 1200);
            } else {
              let data = {};
              try {
                data = await res.json();
              } catch {}
              banUserModalInfo.style.display = "block";
              banUserModalInfo.style.color = "#ffd700";
              banUserModalInfo.textContent =
                data.error || "Kullanıcı silinemedi.";
              banUserYesBtn.disabled = false;
            }
          };
        }
        // Modal dışına tıklayınca kapat
        window.addEventListener("click", function (e) {
          if (e.target === banUserModal) {
            banUserModal.style.display = "none";
            banTargetUser = null;
          }
        });

        // Her 2 saniyede bir mesajları güncelle
        setInterval(fetchAndRenderMessages, 2000);
        // Sayfa açılır açılmaz mesajları getir
        fetchAndRenderMessages();
        setTimeout(() => {
          updateChatHeaderStatus(chatLocked);
        }, 100);
        // EULA modal açma/kapama
        const eulaLink = document.getElementById("eula-link");
        const eulaModal = document.getElementById("eula-modal");
        const closeEulaModal = document.getElementById("close-eula-modal");
        eulaLink.addEventListener("click", function (e) {
          e.preventDefault();
          eulaModal.style.display = "flex";
        });
        closeEulaModal.addEventListener("click", function () {
          eulaModal.style.display = "none";
        });
        window.addEventListener("click", function (e) {
          if (e.target === eulaModal) eulaModal.style.display = "none";
        });

        // EULA ve TOS checkbox referansları
        const registerEulaCheckbox = document.getElementById(
          "register-eula-checkbox"
        );
        const registerTosCheckbox = document.getElementById(
          "register-tos-checkbox"
        );
        const registerSubmitBtn = document.getElementById(
          "register-submit-btn"
        );
        // EULA modalını açmak için kayıt ekranındaki link
        const registerEulaLink = document.getElementById("register-eula-link");
        if (registerEulaLink) {
          registerEulaLink.addEventListener("click", function (e) {
            e.preventDefault();
            const eulaModal = document.getElementById("eula-modal");
            if (eulaModal) eulaModal.style.display = "flex";
          });
        }
        // Terms of Service linki (dummy, EULA ile aynı modalı açabilir veya başka bir modal eklenebilir)
        const registerTosLink = document.getElementById("register-tos-link");
        if (registerTosLink) {
          registerTosLink.addEventListener("click", function (e) {
            e.preventDefault();
            // Şimdilik EULA modalı açılıyor, ayrı bir modal eklemek isterseniz burada açabilirsiniz
            const eulaModal = document.getElementById("eula-modal");
            if (eulaModal) eulaModal.style.display = "flex";
          });
        }
        // Kayıt butonunu checkbox'lara göre aktif/pasif yap
        function updateRegisterBtnState() {
          if (
            registerEulaCheckbox &&
            registerTosCheckbox &&
            registerSubmitBtn
          ) {
            registerSubmitBtn.disabled = !(
              registerEulaCheckbox.checked && registerTosCheckbox.checked
            );
            if (registerSubmitBtn.disabled) {
              registerSubmitBtn.style.background = "#888";
              registerSubmitBtn.style.color = "#ccc";
              registerSubmitBtn.style.cursor = "not-allowed";
            } else {
              registerSubmitBtn.style.background = "#ffd700";
              registerSubmitBtn.style.color = "#222";
              registerSubmitBtn.style.cursor = "pointer";
            }
          }
        }
        if (registerEulaCheckbox && registerTosCheckbox) {
          registerEulaCheckbox.addEventListener(
            "change",
            updateRegisterBtnState
          );
          registerTosCheckbox.addEventListener(
            "change",
            updateRegisterBtnState
          );
          updateRegisterBtnState();
        }

        const deleteAccountBtn = document.getElementById("delete-account-btn");
        const deleteAccountConfirmModal = document.getElementById(
          "delete-account-confirm-modal"
        );
        const deleteAccountVerifyModal = document.getElementById(
          "delete-account-verify-modal"
        );
        const closeDeleteAccountConfirm = document.getElementById(
          "close-delete-account-confirm"
        );
        const closeDeleteAccountVerify = document.getElementById(
          "close-delete-account-verify"
        );
        const deleteAccountConfirmYes = document.getElementById(
          "delete-account-confirm-yes"
        );
        const deleteAccountConfirmNo = document.getElementById(
          "delete-account-confirm-no"
        );
        const deleteAccountVerifyTitle = document.getElementById(
          "delete-account-verify-title"
        );
        const deleteAccountVerifyInput = document.getElementById(
          "delete-account-verify-input"
        );
        const deleteAccountVerifyPassword = document.getElementById(
          "delete-account-verify-password"
        );
        const deleteAccountFinalBtn = document.getElementById(
          "delete-account-final-btn"
        );
        const deleteAccountVerifyError = document.getElementById(
          "delete-account-verify-error"
        );
        // "Hesabı Sil" butonuna basınca ilk modalı aç
        if (deleteAccountBtn) {
          deleteAccountBtn.addEventListener("click", function () {
            deleteAccountConfirmModal.style.display = "flex";
          });
        }
        // İlk modal kapatma
        if (closeDeleteAccountConfirm) {
          closeDeleteAccountConfirm.addEventListener("click", function () {
            deleteAccountConfirmModal.style.display = "none";
          });
        }
        // Hayır'a basınca modalı kapat
        if (deleteAccountConfirmNo) {
          deleteAccountConfirmNo.addEventListener("click", function () {
            deleteAccountConfirmModal.style.display = "none";
          });
        }
        // Evet'e basınca ikinci modalı aç
        if (deleteAccountConfirmYes) {
          deleteAccountConfirmYes.addEventListener("click", function () {
            deleteAccountConfirmModal.style.display = "none";
            // Kullanıcı adını modalda göster
            const user = JSON.parse(
              localStorage.getItem("pixelcar_user") || "{}"
            );
            deleteAccountVerifyTitle.textContent = `${user.username} hesabı silmek için kullanıcı adınızı doğrulayınız;`;
            deleteAccountVerifyInput.value = "";
            if (deleteAccountVerifyPassword)
              deleteAccountVerifyPassword.value = "";
            deleteAccountVerifyError.style.display = "none";
            deleteAccountVerifyModal.style.display = "flex";
          });
        }
        // İkinci modal kapatma
        if (closeDeleteAccountVerify) {
          closeDeleteAccountVerify.addEventListener("click", function () {
            deleteAccountVerifyModal.style.display = "none";
          });
        }
        // Hesabı Sil (doğrulama) butonu
        if (deleteAccountFinalBtn) {
          deleteAccountFinalBtn.addEventListener("click", async function () {
            const user = JSON.parse(
              localStorage.getItem("pixelcar_user") || "{}"
            );
            const inputVal = (deleteAccountVerifyInput.value || "").trim();
            const passwordVal =
              deleteAccountVerifyPassword && deleteAccountVerifyPassword.value
                ? deleteAccountVerifyPassword.value.trim()
                : "";
            if (inputVal !== user.username) {
              deleteAccountVerifyError.textContent =
                "Kullanıcı adını doğru yazmalısınız.";
              deleteAccountVerifyError.style.display = "block";
              return;
            }
            if (!passwordVal) {
              deleteAccountVerifyError.textContent = "Şifrenizi yazmalısınız.";
              deleteAccountVerifyError.style.display = "block";
              return;
            }
            try {
              // Giriş doğrulaması
              const res = await fetch("/api/login-or-register", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                  username: inputVal,
                  password: passwordVal,
                }),
              });
              let data = {};
              try {
                data = await res.json();
              } catch {}
              if (!res.ok || !data.user || data.user.username !== inputVal) {
                deleteAccountVerifyError.textContent =
                  data.error || "Kullanıcı adı veya şifre yanlış.";
                deleteAccountVerifyError.style.display = "block";
                return;
              }
              // Hesabı silme isteği gönderirken şifreyi de gönder!
              const delRes = await fetch("/api/delete-account", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                  username: inputVal,
                  password: passwordVal,
                }),
              });
              if (!delRes.ok) {
                let delData = {};
                try {
                  delData = await delRes.json();
                } catch {}
                deleteAccountVerifyError.textContent =
                  delData.error || "Hesap silinemedi.";
                deleteAccountVerifyError.style.display = "block";
                return;
              }
            } catch (err) {
              deleteAccountVerifyError.textContent = "Sunucuya ulaşılamadı.";
              deleteAccountVerifyError.style.display = "block";
              return;
            }
            deleteAccountVerifyError.style.display = "none";
            localStorage.removeItem("pixelcar_user");
            deleteAccountVerifyModal.style.display = "none";
            window.location.reload();
          });
        }
        // Modal dışına tıklayınca kapat
        window.addEventListener("click", function (e) {
          if (e.target === deleteAccountConfirmModal)
            deleteAccountConfirmModal.style.display = "none";
          if (e.target === deleteAccountVerifyModal)
            deleteAccountVerifyModal.style.display = "none";
        });
      });
    </script>
  </body>
</html>
